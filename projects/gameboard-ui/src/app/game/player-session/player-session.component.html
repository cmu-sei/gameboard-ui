<!-- Copyright 2021 Carnegie Mellon University. All Rights Reserved. -->
<!-- Released under a MIT (SEI)-style license. See LICENSE.md in the project root for license information. -->

<ng-container *ngIf="ctx$ | async as ctx; else loading">
  <div class="card mb-4">
    <div class="card-body">

      <div *ngIf="!(ctx.game.session.isDuring && ctx.player.session?.isDuring)" class="text-info card-text d-flex mb-2">
        <div>
          <span *ngIf="ctx.game.session.isBefore">Game window opens in </span>
          <span *ngIf="ctx.game.session.isDuring">Game window closes in </span>
          <span *ngIf="ctx.game.session.isAfter">Game window is closed </span>
        </div>
        <div class="ml-2">
          {{ctx.game.session.countdown | countdown}}
        </div>
      </div>

      <div class="card-title lead">
        <ng-container *ngIf="!ctx.player.session?.isBefore">
          <div class="d-flex text-info card-text">
            <div>
              <span *ngIf="ctx.player.session?.isAfter">Session ended </span>
              <span *ngIf="ctx.player.session?.isDuring">Time Remaining: </span>
            </div>

            <div [class]="'ml-2 ' + (ctx.player.session?.countdown | countdowncolor)">
              {{ctx.player.session?.countdown | countdown}}
            </div>
            <div class="spacer"></div>

            <app-confirm-button *ngIf="ctx.game.allowReset" class="mx-2" btnClass="btn btn-sm pop-warning"
              (confirm)="handleReset(ctx.player)">
              <fa-icon [icon]="faTrash"></fa-icon>
              <span>Reset Session</span>
            </app-confirm-button>
          </div>
        </ng-container>
      </div>

      <app-player-presence *ngIf="ctx.player" [player$]="player$"></app-player-presence>

      {{performanceSummaryViewModel$ | async }}
      <app-gameboard-performance-summary *ngIf="performanceSummaryViewModel$ | async"
        [ctx$]="performanceSummaryViewModel$"></app-gameboard-performance-summary>

      <table class="table mt-2 text-center">
        <tbody>
          <tr>
            <th>Rank</th>
            <th>Score</th>
            <th>Cumulative Time</th>
            <th>Completes</th>
            <th>Partials</th>
          </tr>
          <tr>
            <td>{{ctx.player.rank}}</td>
            <td>{{ctx.player.score}}</td>
            <td>
              <app-cumulative-time-clock [session]="ctx.player.session"></app-cumulative-time-clock>
            </td>
            <td>{{ctx.player.time | clock}}</td>
            <td>{{ctx.player.correctCount}}</td>
            <td>{{ctx.player.partialCount}}</td>
          </tr>
        </tbody>
      </table>

      <div class="d-flex my-4 align-items-center justify-content-center">
        <a type="button" class="btn btn-secondary" target="_blank" [href]="'game/scores/' + ctx.game.id">
          View Scoreboard
          <fa-icon [icon]="faExternalLink"></fa-icon>
        </a>
      </div>

      <app-error-div [errors]="errors"></app-error-div>

      <ng-container *ngIf="ctx.player.session && ctx.player.session.isBefore && ctx.game.session.isDuring">
        <app-session-start-controls [ctx]="ctx" (onRequestStart)="handleStart(ctx.player)"></app-session-start-controls>

        <div class="card-text" *ngIf="!isDoubleChecking">
          <div class="mb-2">
            <h3>Session Forecast</h3>
            <small class="d-block mb-4">Shows when sessions become available. (Green means available.)</small>
            <div class="text-center forecast">
              <app-session-forecast [game]="ctx.game"></app-session-forecast>
            </div>
          </div>
        </div>
      </ng-container>

      <div *ngIf="!ctx.player.session?.isBefore" class="text-center my-4">
        <a *ngIf="ctx.game.mode != 'unity'" class="btn btn-primary btn-lg"
          [routerLink]="['../board', ctx.player.id]">Continue to Gameboard</a>
        <a *ngIf="ctx.game.mode == 'unity'" class="btn btn-primary bgn-lg"
          [routerLink]="['../unity-board', ctx.player.gameId, ctx.player.id, ctx.player.teamId, ctx.player.sessionEnd]">
          Continue to Cubespace
        </a>
      </div>

      <div class="col d-flex justify-content-center" *ngIf="ctx.game.mapUrl">
        <img [src]=" ctx.game.mapUrl" alt="game map background" class="img-fluid">
      </div>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div class="text-center">
    <app-spinner></app-spinner>
  </div>
</ng-template>
