<ng-container *ngIf="scoreboardData; else loading">
    <alert *ngIf="isLive" type="info">
        This game is still being played. Check back after the round ends
        ({{ scoreboardData.game.isLiveUntil?.toJSDate() | friendlyDateAndTime }})
        to see who came out on top and view complete score breakdowns for
        everyone with points on the board!
    </alert>
    <table *ngIf="scoreboardData.teams.length; else noScore" class="table table-striped gameboard-table w-100"
        [class.table-hover]="!isLive">
        <col class="width-5">
        <col>
        <col>
        <col>
        <col>

        <thead class="thead-light">
            <tr class="headers">
                <th scope="col"></th>
                <th scope="col"> {{ scoreboardData.game.isTeamGame ? "Team" : "Player" }} </th>
                <th scope="col">Challenges</th>
                <th scope="col" class="text-center tooltipped-column-header" [tooltip]="cumulativeTimeTooltip"
                    placement="top">
                    <span class="tooltipped-column-header">Cumulative Time</span>
                </th>
                <th scope="col" class="text-center">Score</th>
            </tr>
        </thead>

        <tbody>
            <tr *ngFor="let teamScore of scoreboardData.teams; index as i" class="data-row"
                [class.cursor-pointer]="!isLive" (click)="!isLive && handleRowClick(teamScore)">
                <td>
                    <div class="team-rank d-flex flex-column justify-content-center align-items-center">
                        {{ teamScore.score.rank }}
                    </div>
                </td>
                <td>
                    <div class="team-container d-flex align-items-center">
                        <div class="flex-grow-1"
                            *ngTemplateOutlet="scoreboardData.game.isTeamGame ? teamNamePanel : playerNamePanel; context: {$implicit: teamScore};">
                        </div>
                        <div class="badge badge-info fs-09"
                            *ngIf="teamScore.sessionEnds | datetimeToDate | dateToCountdown | async as sessionEnds">
                            {{ sessionEnds }}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="challenge-count" *ngIf="teamScore.score.solveCountComplete">
                        <span class="font-bold text-info">{{ teamScore.score.solveCountComplete }}</span>
                        <span class="challenge-count-desc"> complete</span>
                    </div>

                    <div class="challenge-count" *ngIf="teamScore.score.solveCountPartial">
                        <span class="font-bold">{{ teamScore.score.solveCountPartial }}</span>
                        <span class="challenge-count-desc"> partial</span>
                    </div>

                    <div class="challenge-count"
                        *ngIf="teamScore.score.solveCountPartial + teamScore.score.solveCountComplete < scoreboardData.game.specCount">
                        <span class="font-bold">
                            {{ scoreboardData.game.specCount - (teamScore.score.solveCountPartial +
                            teamScore.score.solveCountComplete) }}
                        </span>
                        <span class="challenge-count-desc"> unattempted</span>
                    </div>
                </td>
                <td>
                    <div class="playtime challenge-count text-center">
                        {{ teamScore.score.cumulativeTimeMs | msToDuration }}
                    </div>
                </td>
                <td class="text-center" [tooltip]="teamScore.score | scoreToTooltip:isLive">
                    <span class="score text-center"
                        [class.text-info]="teamScore.score.scoreOverall != teamScore.score.scoreChallenge">
                        {{ teamScore.score.scoreOverall }}
                    </span>
                </td>
            </tr>
        </tbody>
    </table>
</ng-container>

<ng-template #loading>
    <app-spinner></app-spinner>
</ng-template>

<ng-template #noScore>
    <div class="no-score gray-text text-center">
        No one's scored in this game yet.
    </div>
</ng-template>

<ng-template #playerNamePanel let-context>
    <div class="player-name-panel-container flex-grow-1 d-flex align-items-center">
        <app-player-avatar [player]="context.players[0]" class="mr-2"></app-player-avatar>

        <div class="player-name ml-2">
            {{context.players[0].name}}
        </div>
    </div>
</ng-template>

<ng-template #teamNamePanel let-context>
    <div class="team-names-container flex-grow-1 ml-2">
        <h5 class="team-name m-0">{{context.score.teamName}}</h5>
        <ul class="player-names-list d-flex mt-2 mb-0">
            <li *ngFor="let player of context.players" class="mr-2">
                <app-player-avatar [player]="player" [showSponsorTooltip]="false" size="tiny"
                    [tooltip]="player.name + ' // ' + player.sponsor.name" placement="bottom"></app-player-avatar>
            </li>
        </ul>
    </div>
</ng-template>
