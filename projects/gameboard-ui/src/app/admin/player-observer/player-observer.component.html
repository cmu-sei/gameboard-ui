<!-- Copyright 2021 Carnegie Mellon University. All Rights Reserved. -->
<!-- Released under a MIT (SEI)-style license. See LICENSE.md in the project root for license information. -->

<a class="btn btn-link mr-2" routerLink="/admin">
  <fa-icon [icon]="faArrowLeft"></fa-icon>
  <span>Back</span>
</a>
<button class="btn btn-link mr-2" (click)="refresh$.next(true)">
  <fa-icon [icon]="faSync"></fa-icon>
  <span>Refresh</span>
</button>
<div class="d-flex">
  <h2>Observe Players</h2>
  <a *ngIf="!!gid" class="btn btn-link mr-2 align-self-center" [routerLink]="['/admin/observer/challenges', gid]">
    <span>Observe Challenges</span>
  </a>
</div>
<div class="row">
  <div class="input-group mt-2 mb-3 col-5">
    <div class="input-group-prepend">
      <span id="search-label" class="input-group-text">Search</span>
    </div>
    <input id="search-input" type="search" class="form-control" #search (input)="typing$.next(search.value)"
      aria-label="search term" aria-describedby="search-label" placeholder="term">
  </div>
  <div class="input-group mt-2 mb-0 ml-auto col-5">
    <div id="feedbackType-input" #selectType class="btn-group mb-2 ml-auto" btnRadioGroup name="sortType" tabindex="0"
      [(ngModel)]="sort" [ngModelOptions]="{updateOn: 'change'}">
      <label class="btn btn-outline-dark btn-md text-white" btnRadio="byName">
        <fa-icon [icon]="faSortAlphaDown"></fa-icon>
        Name
      </label>
      <label class="btn btn-outline-dark btn-md text-white" btnRadio="byRank">
        <fa-icon [icon]="faSortAmountDown"></fa-icon>
        Rank
      </label>
    </div>
  </div>
</div> <!-- end row for search and filtering -->

<!-- Table of challenges -->
<div class="bg-dark">
  <div class="row mx-0 py-2">
    <h4 class="col-3 text-left pl-3">Team/Player</h4>
    <h4 class="col-2 text-center">User</h4>
    <h4 class="col-2 text-center">Game Score</h4>
    <h4 class="col-3 text-center">Cumulative Time</h4>
    <h4 class="col-2 text-right">Console</h4>
  </div>
  <div class="d-flex flex-column">
    <ng-container *ngIf="{actors: fetchActors$ | async, term : (term$ | async) ?? ''} as updates">
      <div *ngFor="let row of table | keyvalue: sortByName; trackBy: trackByChallengeId;" [hidden]="!(row.value | matchesterm:updates.term:'name':'userName')"
        [ngStyle]="{'order': row.value.rank | observeorder:row.value.pinned:sort:maxRank }" [class]="row.value.pinned ? 'pinned' : ''">
        <div class="row mx-0 border-top border-light py-2">
          <div class="col-3 align-self-center pl-1 text-left">
            <button class="mr-1 btn btn-sm border-0" [class]="row.value.pinned ?  'btn-outline-success' : 'btn-outline-light'" 
              (click)="togglePinRow(row.value)">
              <fa-icon class="pin-icon" [icon]="faAngleDoubleUp" [rotate]="row.value.pinned ? 90 : undefined"></fa-icon>
            </button>
            <span class="text-break">{{row.value.approvedName}}</span>
          </div>
          <div class="col-2 align-self-center text-center">{{row.value.userName}}</div>
          <div class="col-2 align-self-center text-center">{{row.value.score | number}}</div>
          <div class="col-3 align-self-center text-center">{{row.value.time | clock }}</div>
          <div class="col-2 align-self-center text-right">
            <button *ngIf="true" class="btn btn-sm btn-outline-success mx-2"
              (click)="go(row.value)">
              <fa-icon [icon]="faExternalLinkAlt"></fa-icon>
            </button>
            <button *ngIf="true" class="btn btn-sm" [class]="row.value.expanded ? 'btn-success' : 'btn-outline-success' "
              (click)="toggleShowConsole(row.value)">
              <fa-icon [icon]="faGrid"></fa-icon>
            </button>
          </div>
        </div> <!-- end main challenge row -->
        <ng-container *ngIf="row.value.expanded && (row.value | matchesterm:updates.term:'playerName':'name')">
          <div class="row mx-0 mt-1">
            <ng-container *ngIf="updates.actors?.get(row.value.userId) as vm; else empty">
              <div class="p-2 vm-console mx-auto" [class]="row.value.fullWidthVM ? 'col-12' : 'col-6'">
                <div class="rounded border border-success h-100 d-flex flex-column">
                  <div class="mt-1 ml-1 mx-0 px-0 d-flex justify-content-between">
                    <div class="mx-1 px-0 text-center align-self-center">
                      <span class="mx-1 text-success text-break">{{vm.challengeName}}</span>
                      <span class="mx-3 text-success text-break">{{vm.vmName}}</span>
                    </div>
                    <div class="mx-0 px-0 text-right">
                      <button class="btn btn-outline-success btn-sm px-2 py-1 border-0 mr-1 z10" (click)="toggleFullWidthVM(row.value)">
                        <fa-icon [icon]="row.value.fullWidthVM ? faCompressAlt : faExpandAlt"></fa-icon>
                      </button>
                    </div>
                  </div> <!-- end console header -->
                  <div class="iframe-wrapper mt-auto" style="padding: 0px;">
                    <iframe class="rounded-bottom w-100 h-100" frameborder="0"
                      [src]="(mksHost+'?f=0&o=1&s='+vm.challengeId+'&v='+vm.vmName) | safeurl">
                    </iframe>
                  </div> <!-- end iframe wrapper -->
                </div>
              </div>
            </ng-container>
          </div> <!-- end row for console grid -->
        </ng-container> <!-- end expanded section of row -->
      </div>
    </ng-container>
  </div>
</div> <!-- end table of challenges -->


<ng-template #empty>
  <p class="text-center mx-auto">
    No active consoles for this user.
  </p>
</ng-template>