<div class="enrollment-report-params">
    <app-report-parameters-container>
        <app-multi-select label="Series" name="series" ngDefaultControl [options]="series$ | async"
            [(ngModel)]="seriesQueryModel"></app-multi-select>
        <app-multi-select label="Tracks" name="tracks" ngDefaultControl [options]="tracks$ | async"
            [(ngModel)]="tracksQueryModel"></app-multi-select>
        <app-multi-select label="Seasons" name="seasons" ngDefaultControl [options]="seasons$ | async"
            [(ngModel)]="seasonsQueryModel"></app-multi-select>
        <app-multi-select label="Games" name="games" [options]="games$ | async" [(ngModel)]="gamesQueryModel"
            [itemTemplate]="multiSelectGame" [getSearchText]="displayGameName"
            [value]="getGameValue"></app-multi-select>
        <app-parameter-sponsor name="sponsors" ngDefaultControl></app-parameter-sponsor>
        <app-parameter-date-range label="Enrollment Date" ngDefaultControl
            [(ngModel)]="enrollmentDateRangeModel"></app-parameter-date-range>
    </app-report-parameters-container>
</div>

<div class="report-body" *ngIf="!isLoading; else loading">
    <ng-container *ngIf="ctx$ | async as ctx">
        <app-report-stat-summary class="d-block mb-4" *ngIf="ctx.results.records.length"
            [importantStat]="leadingSponsorStat" [stats]="stats"></app-report-stat-summary>
        <tabset *ngIf="ctx.results.records.length; else noRecords">
            <tab heading="Summary Table" id="tab-summary-table"
                [active]="selectedParameters?.tab == 'summary' || !selectedParameters?.tab"
                (selectTab)="handleTabClick('summary')">
                <div class="results">
                    <table class="report-table table-hover gameboard-report">
                        <colgroup span="3"></colgroup>
                        <colgroup span="5"></colgroup>

                        <thead class="thead-light">
                            <tr class="headers super-headers-row">
                                <th scope="col" colSpan="3" class="group-header">Enrollment</th>
                                <th scope="col" colSpan="5" class="group-header">Performance</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr class="headers headers-row">
                                <td>Player</td>
                                <td>Enroll Date</td>
                                <td>Game</td>
                                <td>Cumulative Time</td>
                                <td>Attempted</td>
                                <td>Partially Solved</td>
                                <td>Completely Solved</td>
                                <td>Score</td>
                            </tr>

                            <tr class="data-row" *ngFor="let record of ctx.results.records">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <app-player-field class="d-block"
                                            [player]="{ userId: record.player.id, name: record.player.name, sponsor: record.player.sponsor, team: record.game.isTeamGame ? record.team : undefined }"></app-player-field>
                                    </div>
                                </td>
                                <td class="report-field date">
                                    <ng-container *ngIf="record.player.enrollDate else noValue">
                                        <p>{{ record.player.enrollDate | shortdate }}</p>
                                        <p class="subtle-info">{{ record.player.enrollDate | friendlyTime }}</p>
                                    </ng-container>
                                </td>
                                <td>
                                    <p class="game-name m-0">{{ record.game.name }}</p>
                                    <p class="game-info subtle-info">
                                        <span *ngIf="record.game.series">
                                            <app-parameter-change-link
                                                [config]="{ parameterChange: { series: record.game.series } }">
                                                {{ record.game.series }}
                                            </app-parameter-change-link>
                                            ::
                                        </span>
                                        <span *ngIf="record.game.season">
                                            <app-parameter-change-link
                                                [config]="{ parameterChange: { seasons: record.game.season }}">
                                                {{ record.game.season }}
                                            </app-parameter-change-link>
                                            ::
                                        </span>
                                        <span *ngIf="record.game.track; else noValue">
                                            <app-parameter-change-link
                                                [config]="{ parameterChange: { tracks: record.game.track }}">
                                                {{ record.game.track }}
                                            </app-parameter-change-link>
                                        </span>
                                    </p>
                                </td>
                                <td class="report-field numerical">
                                    <p class="report-field" *ngIf="record.playTime.durationMs; else noValue">
                                        {{ record.playTime.durationMs | msToDuration }}
                                    </p>
                                </td>
                                <td class="report-field numerical">
                                    <p class="challenges-deployed">
                                        <span [class.tooltipped-value]="record.challenges.length"
                                            (click)="record.challenges && showChallengesDetail(record, 'deployed')">
                                            {{ record.challenges | arrayToCount }}
                                        </span>
                                    </p>
                                </td>
                                <td class="report-field numerical">
                                    <p class="count challenges-partial">
                                        <span [class.tooltipped-value]="record.challengesPartiallySolvedCount"
                                            (click)="record.challengesPartiallySolvedCount && showChallengesDetail(record, 'partial')">
                                            {{ record.challengesPartiallySolvedCount }}
                                        </span>
                                    </p>
                                </td>
                                <td class="report-field numerical">
                                    <p class="count challenges-complete">
                                        <span [class.tooltipped-value]="record.challengesCompletelySolvedCount"
                                            (click)="record.challengesCompletelySolvedCount && showChallengesDetail(record, 'complete')">
                                            {{ record.challengesCompletelySolvedCount }}
                                        </span>
                                    </p>
                                </td>
                                <td class="report-field numerical">
                                    <p>
                                        <span [class.tooltipped-value]="(record.score || 0) > 0"
                                            (click)="(record.score || 0) && showScoreBreakdown(record)">
                                            {{ record.score }}
                                        </span>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pager-container d-flex justify-content-end mt-4">
                    <div class="flex-grow-1"></div>
                    <app-select-pager [itemCount]="results?.paging?.itemCount"
                        [pageSize]="results?.paging?.pageSize || 20"
                        (change)="handlePagingChange($event)"></app-select-pager>
                </div>
            </tab>

            <tab heading="Enrollment Over Time" id="tab-trend-line" [active]="selectedParameters?.tab == 'trend'"
                (selectTab)="handleTabClick('trend')">
                <div class="trend-line-container mt-4">
                    <app-line-chart id="enrollmentTrend" [config]="ctx.chartConfig"></app-line-chart>
                </div>
            </tab>

            <tab heading="By Game" id="tab-by-game" [active]="selectedParameters?.tab == 'game'"
                (selectTab)="handleTabClick('game')">
                <div class="by-game-container mt-4">
                    <app-enrollment-report-by-game [parameters]="selectedParameters"></app-enrollment-report-by-game>
                </div>
            </tab>
        </tabset>
    </ng-container>
</div>

<ng-template #loading>
    <div class="page-height d-flex flex-column align-items-center justify-content-center">
        <app-spinner>Loading your report...</app-spinner>
    </div>
</ng-template>

<ng-template #noRecords>
    <app-no-report-records recordDescription="enrollments"></app-no-report-records>
</ng-template>

<ng-template #noValue>
    <app-report-field-no-value></app-report-field-no-value>
</ng-template>

<ng-template #multiSelectGame let-context>
    <span class="game-name">{{ context.name }}</span>
</ng-template>
