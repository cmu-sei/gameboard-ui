<div class="challenge-report-component" *ngIf="ctx$ | async as ctx; else loading">
    <app-report-parameters-container>
        <app-parameter-series [(ngModel)]="selectedParameters.competition" ngDefaultControl
            name="competition"></app-parameter-series>
        <app-parameter-track [(ngModel)]="selectedParameters.track" [hideModifierSelect]="true" ngDefaultControl
            name="track"></app-parameter-track>
        <app-parameter-game-challengespec ngDefaultControl
            [(ngModel)]="selectedParameters.gameChallengeSpec"></app-parameter-game-challengespec>
    </app-report-parameters-container>

    <div class="report-body mt-4" *ngIf="ctx.records.length" #challengesReport>
        <table class="report-table table-hover gameboard-report">
            <col>
            <col>
            <colgroup span="4"></colgroup>
            <colgroup span="2"></colgroup>
            <colgroup span="2"></colgroup>
            <col>

            <thead class="thead-light">
                <tr class="headers super-headers-row">
                    <th scope="col"></th>
                    <th scope="col"></th>
                    <th scope="col" colSpan="4" class="group-header">Player Engagement</th>
                    <th scope="col" colspan="2" class="group-header">Solve Times</th>
                    <th scope="col" colspan="2" class="group-header">Scores</th>
                    <th scope="col" class="group-header">Support</th>
                </tr>
            </thead>

            <tbody>
                <tr class="headers headers-row">
                    <td>Game</td>
                    <td>Challenge</td>
                    <td>Eligible</td>
                    <td>Started</td>
                    <td>Partial Solve</td>
                    <td>Complete Solve</td>
                    <td>Fastest</td>
                    <td>Avg. Complete Solve Time</td>
                    <td>Max Possible</td>
                    <td>Avg.</td>
                    <td>Tickets</td>
                </tr>

                <tr class="data-row" *ngFor="let record of ctx.records">
                    <td>{{record.game.name}}</td>
                    <td>{{record.challengeSpec.name}}</td>
                    <td class="text-center">
                        <a [routerLink]="['/reports/players-report']"
                            [queryParams]="{ 'challengeSpecId': record.challengeSpec.id }">
                            {{record.playersEligible}}
                        </a>
                    </td>
                    <td class="text-center">{{record.playersStarted}}</td>
                    <td class="text-center">{{record.playersWithPartialSolve}}</td>
                    <td class="text-center">{{record.playersWithCompleteSolve}}</td>
                    <td>
                        <div *ngIf="record.fastestSolve; else noSolve" class="fastest-solve-cell">
                            <span class="tooltipped-value" [tooltip]="'Solved by ' + record.fastestSolve.player.name">
                                {{record.fastestSolve.solveTimeMs | msToDuration}}</span>
                        </div>

                        <ng-template #noSolve>--</ng-template>
                    </td>
                    <td class="text-center">{{(record.meanCompleteSolveTimeMs | msToDuration) || '--'}}</td>
                    <td class="text-center">{{record.maxPossibleScore}}</td>
                    <td class="text-center">{{record.meanScore || '--'}}</td>
                    <td class="text-center">
                        <a *ngIf="record.ticketCount && record.challengeSpec; else cantLink"
                            [routerLink]="['/reports/support-report']"
                            [queryParams]="{ gameId: record.game.id, challengeSpecId: record.challengeSpec.id }">
                            {{record.ticketCount}}
                        </a>

                        <ng-template #cantLink>
                            {{record.ticketCount || 0}}
                        </ng-template>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="chart-container full-width d-flex mt-5 justify-content-center align-items-center"
            *ngIf="chartConfig">
            <app-doughnut-chart [config]="chartConfig"></app-doughnut-chart>
        </div>
    </div>
</div>

<ng-template #loading><app-spinner></app-spinner></ng-template>
